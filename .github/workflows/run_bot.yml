name: Ultimate Trading Bot v36.12 (Production)

on:
  schedule:
    # æ¯45åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '*/45 * * * *'
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨è§¦å‘

# é˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹ï¼Œé¿å…å†·å´çŠ¶æ€å†²çª
concurrency:
  group: trading-bot
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.10'
  JOB_TIMEOUT_MINUTES: 15

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.JOB_TIMEOUT_MINUTES }}   # ä½œä¸šçº§è¶…æ—¶ä¿æŠ¤

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'                     # ç¼“å­˜ pip ä¾èµ–ï¼ŒåŠ é€Ÿå®‰è£…

      # ===================== å†·å´çŠ¶æ€æŒä¹…åŒ–ç¼“å­˜ =====================
      - name: Restore cooldown state
        uses: actions/cache@v4
        with:
          path: cooldown_state.pkl
          # å›ºå®š keyï¼Œæ¯æ¬¡è¿è¡Œè¦†ç›–ï¼›restore-keys æä¾›å›é€€åˆ°å†å²ç¼“å­˜
          key: cooldown-state-v36
          restore-keys: |
            cooldown-state-

      # ===================== å®‰è£…ä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰=====================
      - name: Install dependencies (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_on: error
          command: |
            python -m pip install --upgrade pip
            pip install pandas numpy requests pyTelegramBotAPI scipy

      # ===================== è¿è¡Œä¸»ç¨‹åºï¼ˆå¸¦é‡è¯•ä¸æ—¥å¿—ï¼‰=====================
      - name: Run Ultimate Trading System
        id: run_bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONUNBUFFERED: 1               # å®æ—¶è¾“å‡ºæ—¥å¿—
        run: |
          # ç®€å• shell é‡è¯•å¾ªç¯ï¼ˆ3æ¬¡ï¼‰
          for attempt in 1 2 3; do
            echo "ğŸš€ Attempt $attempt of 3..."
            if python main.py; then
              echo "âœ… Analysis completed successfully."
              exit 0
            else
              echo "âŒ Attempt $attempt failed."
              if [ $attempt -lt 3 ]; then
                echo "â³ Waiting 15 seconds before retry..."
                sleep 15
              fi
            fi
          done
          echo "ğŸ’¥ All attempts failed." >&2
          exit 1

      # ===================== å¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿— =====================
      - name: Upload failure logs
        if: failure() && steps.run_bot.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: trading-bot-logs-${{ github.run_id }}
          path: |
            *.log
            cooldown_state.pkl
          retention-days: 7

      # ===================== å¯é€‰ï¼šå‘é€è¿è¡Œå®Œæˆé€šçŸ¥ =====================
      - name: Notify completion via Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="ğŸ¤– åˆ†æä»»åŠ¡å®Œæˆ (Run ID: ${{ github.run_id }})%0AçŠ¶æ€: $STATUS"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d disable_notification=true