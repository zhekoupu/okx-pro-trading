name: Run Bot v36.12

on:
  schedule:
    - cron: '*/45 * * * *'   # æ¯45åˆ†é’Ÿè¿è¡Œï¼ˆUTCï¼‰
  workflow_dispatch:

# ===============================
# å¹¶å‘é”ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰
# ===============================
concurrency:
  group: ultimate-trading-bot
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.10'
  JOB_TIMEOUT_MINUTES: 15

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.JOB_TIMEOUT_MINUTES }}

    steps:

      # 1ï¸âƒ£ è®°å½•å¼€å§‹æ—¶é—´
      - name: Record start time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      # 2ï¸âƒ£ æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 4ï¸âƒ£ å†·å´çŠ¶æ€æŒä¹…åŒ–
      - name: Restore cooldown state
        uses: actions/cache@v4
        with:
          path: cooldown_state.pkl
          key: cooldown-state-v36-${{ github.ref_name }}
          restore-keys: |
            cooldown-state-v36-
            cooldown-

      # 5ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆä¼ä¸šçº§é‡è¯•ï¼‰
      - name: Install dependencies
        run: |
          for attempt in 1 2 3; do
            echo "ğŸ“¦ Install attempt $attempt..."
            python -m pip install --upgrade pip
            pip install pandas numpy requests pyTelegramBotAPI scipy && break
            if [ $attempt -lt 3 ]; then
              echo "Retrying in 20s..."
              sleep 20
            else
              echo "Dependency installation failed."
              exit 1
            fi
          done

      # 6ï¸âƒ£ è¿è¡Œä¸»ç¨‹åºï¼ˆå¸¦è¶…æ—¶ + é‡è¯•ï¼‰
      - name: Run Ultimate Smart Trading System v36.12
        id: run_bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONUNBUFFERED: 1
        run: |
          SUCCESS=0
          for attempt in 1 2 3; do
            echo "ğŸš€ Attempt $attempt..."
            timeout 600 python main.py && SUCCESS=1 && break
            echo "âŒ Attempt $attempt failed."
            if [ $attempt -lt 3 ]; then
              echo "â³ Waiting 60s before retry..."
              sleep 60
            fi
          done

          if [ $SUCCESS -ne 1 ]; then
            echo "ğŸ’¥ All attempts failed."
            exit 1
          fi

      # 7ï¸âƒ£ è®¡ç®—æ‰§è¡Œè€—æ—¶
      - name: Calculate execution time
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "EXEC_DURATION=$DURATION" >> $GITHUB_ENV
          echo "Execution took ${DURATION} seconds."

      # 8ï¸âƒ£ ä¸Šä¼ è¿è¡Œäº§ç‰©ï¼ˆå®¡è®¡ç”¨ï¼‰
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-run-${{ github.run_id }}
          path: |
            *.log
            *.pkl
          retention-days: 7

      # 9ï¸âƒ£ ä¼ä¸šçº§è¿è¡ŒæŠ¥å‘Šï¼ˆå¥åº·ç›‘æ§ï¼‰
      - name: Send Telegram Report
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          ICON="âœ…"
          if [ "$STATUS" != "success" ]; then
            ICON="âŒ"
          fi

          MESSAGE="$ICON Enterprise Run Report
Status: $STATUS
Duration: ${EXEC_DURATION}s
Run ID: ${{ github.run_id }}
Branch: ${{ github.ref_name }}"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d disable_notification=true